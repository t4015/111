<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新しいパスワードの設定 - 根本原因から学ぶWebセキュリティ</title>

    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
    

</head>
<body>
    {% include "components/header.html" %}

    <div class="login-container">
        
        <h1 class="login-title">新しいパスワードの設定</h1>

        <div id="message-area" class="message-area"></div>
        
        <p class="page-description">
            新しいパスワードを入力してください。
        </p>

        <form id="reset-password-form">
            
            <div class="form-group">
                <label for="new_password">新しいパスワード</label>
                <input type="password" id="new_password" name="new_password" required>
            </div>

            <div class="form-group">
                <label for="confirm_password">新しいパスワード (確認用)</label>
                <input type="password" id="confirm_password" name="confirm_password" required>
            </div>
            
            <input type="hidden" id="reset_token" name="reset_token">

            <button type="submit" class="login-button" id="submit-button">パスワードを更新</button>

            <div class="form-links">
                <a href="/login">ログインページに戻る</a>
            </div>

        </form>
     
        <div id="success-message-area" style="display: none; text-align: center; margin-top: 20px;">
            <a href="/login" class="success-button">ログイン画面へ</a>
        </div>

    </div>

    <script>
        const messageArea = document.getElementById('message-area');
        const submitButton = document.getElementById('submit-button');
        const resetForm = document.getElementById('reset-password-form');
        const tokenInput = document.getElementById('reset_token');
        const successMessageArea = document.getElementById('success-message-area');
        const pageDescription = document.querySelector('.page-description');

        // (1) ページ読み込み時にURLからトークンを取得
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                
                if (token) {
                    tokenInput.value = token;
                } else {
                    throw new Error('トークンが見つかりません。');
                }
            } catch (error) {
                showMessage('無効なリンクです。もう一度パスワードリセットを申請してください。', 'error');
                submitButton.disabled = true;
            }
        });

        // (2) フォーム送信時の処理
        resetForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (newPassword !== confirmPassword) {
                showMessage('新しいパスワードが一致しません。', 'error');
                return;
            }
            
            showMessage('', 'clear');
            submitButton.disabled = true;
            submitButton.textContent = '更新中...';

            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            // 改善版: 相対パスを使用
            fetch('/api/reset_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showMessage(result.message, 'success');
                    resetForm.style.display = 'none';
                    pageDescription.style.display = 'none';
                    successMessageArea.style.display = 'block';
                } else {
                    showMessage(result.message || 'パスワードの更新に失敗しました。', 'error');
                    submitButton.disabled = false;
                    submitButton.textContent = 'パスワードを更新';
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                showMessage('サーバーとの通信に失敗しました。', 'error');
                submitButton.disabled = false;
                submitButton.textContent = 'パスワードを更新';
            });
        });

        function showMessage(message, type = 'success') {
            if (type === 'clear') {
                messageArea.style.display = 'none';
                return;
            }
            messageArea.textContent = message;
            messageArea.className = `message-area ${type === 'success' ? 'message-success' : 'message-error'}`;
            messageArea.style.display = 'block';
        }
    </script>

</body>
</html>