<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ content_title }} - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å­¦ç¿’ãƒãƒ¼ã‚¿ãƒ«</title>
    <!-- èª­ã¿ã‚„ã™ã„UDãƒ•ã‚©ãƒ³ãƒˆã¨ã‚¢ã‚¤ã‚³ãƒ³ -->
    <link href="https://fonts.googleapis.com/css2?family=BIZ+UDPGothic:wght@400;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            /* ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
            --color-bg: #f9fafb;       /* èƒŒæ™¯: è–„ã„ã‚°ãƒ¬ãƒ¼ */
            --color-surface: #ffffff;  /* ã‚«ãƒ¼ãƒ‰èƒŒæ™¯: ç™½ */
            --color-text-main: #333333; /* æ–‡å­—: æ¿ƒã„ã‚°ãƒ¬ãƒ¼ */
            --color-text-sub: #555555;
            --color-border: #e5e7eb;
            
            --color-primary: #0056b3;  /* é’: ãƒªãƒ³ã‚¯ãƒ»ãƒ¡ã‚¤ãƒ³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ (è‰²è¦šå¤šæ§˜æ€§ã«é…æ…®) */
            --color-primary-dark: #004494;
            --color-accent: #d32f2f;   /* èµ¤: ã‚¨ãƒ©ãƒ¼ãƒ»å¼·èª¿ */
            --color-success: #2e7d32;  /* ç·‘: æˆåŠŸãƒ»å®Œäº† */
            --color-warning: #ed6c02;  /* ã‚ªãƒ¬ãƒ³ã‚¸: æ³¨æ„ãƒ»ãƒ’ãƒ³ãƒˆ */
            
            --border-radius: 8px;
            --shadow-card: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --focus-ring: 0 0 0 3px rgba(0, 86, 179, 0.4); /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®æ ç·š */
            
            --font-base: "BIZ UDPGothic", "Noto Sans JP", "Hiragino Kaku Gothic ProN", sans-serif;
            --font-mono: "BIZ UDGothic", "Consolas", monospace;
        }

        body {
            font-family: var(--font-base);
            background-color: var(--color-bg);
            color: var(--color-text-main);
            margin: 0;
            padding: 0;
            line-height: 1.7;
            font-size: 16px;
        }

        /* ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œãƒªã‚»ãƒƒãƒˆ */
        *:focus-visible {
            outline: none;
            box-shadow: var(--focus-ring);
        }
        
        button, a {
            cursor: pointer;
            touch-action: manipulation;
        }

        /* --- ãƒ˜ãƒƒãƒ€ãƒ¼ --- */
        .ud-header {
            background-color: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .site-logo a {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-text-main);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .site-logo .icon { color: var(--color-primary); font-size: 1.5rem; }

        .header-btn {
            font-size: 1rem;
            font-weight: 700;
            color: var(--color-surface);
            background-color: var(--color-primary);
            padding: 10px 20px;
            border-radius: var(--border-radius);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.2s;
        }
        .header-btn:hover { background-color: var(--color-primary-dark); }

        /* --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ --- */
        .main-wrapper {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .breadcrumb-nav {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-link {
            display: inline-flex;
            align-items: center;
            color: var(--color-text-sub);
            text-decoration: none;
            font-weight: 500;
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background: #fff;
            transition: all 0.2s;
        }
        .nav-link:hover {
            background-color: #f3f4f6;
            color: var(--color-text-main);
            border-color: #d1d5db;
        }
        .nav-link .icon { margin-right: 5px; font-size: 1.2rem; }
        
        .next-link {
            background-color: var(--color-primary);
            color: #fff;
            border-color: var(--color-primary);
        }
        .next-link:hover {
            background-color: var(--color-primary-dark);
            color: #fff;
        }
        .next-link .icon { margin-left: 5px; margin-right: 0; }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (èª¿æ•´æ¸ˆã¿) */
        .content-grid {
            display: grid;
            grid-template-columns: 1.1fr 0.9fr; /* å·¦å³ã®ãƒãƒ©ãƒ³ã‚¹ã‚’èª¿æ•´ */
            gap: 30px;
            margin-bottom: 40px;
            align-items: start; /* ä¸Šæƒãˆã§å›ºå®š */
        }
        @media (max-width: 900px) {
            .content-grid { grid-template-columns: 1fr; }
        }

        /* --- ã‚«ãƒ¼ãƒ‰ --- */
        .ud-card {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-card);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .card-header {
            background-color: #f3f4f6;
            padding: 15px 20px;
            border-bottom: 1px solid var(--color-border);
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--color-text-main);
        }
        .card-body {
            padding: 20px;
        }

        /* --- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ --- */
        .video-container {
            position: relative;
            padding-bottom: 56.25%;
            height: 0;
            background: #000;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .video-container iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }

        .lesson-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .lesson-title {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1.4;
            color: var(--color-text-main);
        }

        .lesson-description {
            font-size: 1rem;
            color: var(--color-text-main);
            margin-bottom: 20px;
        }

        /* UDãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
        .ud-checkbox {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 16px;
            border: 2px solid var(--color-border);
            border-radius: 30px;
            transition: all 0.2s;
            user-select: none;
            background-color: #fff;
            flex-shrink: 0; /* ç¸®ã¾ãªã„ã‚ˆã†ã«ã™ã‚‹ */
        }
        .ud-checkbox:hover { background-color: #f9fafb; border-color: #d1d5db; }
        .ud-checkbox:focus-within { box-shadow: var(--focus-ring); border-color: var(--color-primary); }
        
        .ud-checkbox input {
            appearance: none;
            -webkit-appearance: none;
            width: 20px; height: 20px;
            border: 2px solid var(--color-text-sub);
            border-radius: 4px;
            margin-right: 10px;
            position: relative;
            background: #fff;
        }
        
        .ud-checkbox input:checked {
            background-color: var(--color-success);
            border-color: var(--color-success);
        }
        .ud-checkbox input:checked::after {
            content: 'âœ”';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 14px;
        }
        
        .ud-checkbox-label {
            font-weight: 700;
            color: var(--color-text-sub);
        }
        .ud-checkbox input:checked ~ .ud-checkbox-label {
            color: var(--color-success);
        }

        /* --- ãƒ‘ã‚ºãƒ« (ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿è­·) --- */
        .puzzle-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
            flex-wrap: wrap; gap: 10px;
        }
        .puzzle-actions button {
            background: #fff; border: 1px solid var(--color-border); padding: 6px 12px; border-radius: 4px;
            font-size: 0.9rem; color: var(--color-text-sub); margin-left: 8px; font-weight: 500;
        }
        .puzzle-actions button:hover { background-color: #f3f4f6; color: var(--color-text-main); }

        .word-bank {
            display: flex; flex-wrap: wrap; gap: 10px; min-height: 50px;
            padding: 15px; background-color: #f3f4f6; border-radius: 6px; border: 1px dashed #d1d5db;
            align-content: flex-start; /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¸Šå¯„ã› */
        }
        
        .word-chip {
            background-color: #fff;
            border: 2px solid var(--color-primary);
            color: var(--color-primary-dark);
            padding: 8px 12px; /* å°‘ã—ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
            border-radius: 6px;
            font-weight: 700;
            font-family: var(--font-mono);
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.95rem;
        }
        .word-chip:hover { background-color: #e0f2fe; }
        .word-chip:focus { box-shadow: var(--focus-ring); }

        .answer-feedback {
            margin-top: 15px;
            padding: 15px;
            background-color: #fff3e0;
            border-left: 4px solid var(--color-warning);
            border-radius: 4px;
            display: none;
            word-break: break-all; /* é•·ã„ã‚³ãƒãƒ³ãƒ‰ã§å´©ã‚Œãªã„ã‚ˆã†ã« */
        }
        .answer-feedback strong { color: #e65100; }

        /* --- ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ (ã‚µã‚¤ã‚ºèª¿æ•´) --- */
        .window-frame {
            border: 2px solid var(--color-text-main);
            border-radius: 6px;
            overflow: hidden;
            background: #fff;
            display: flex; flex-direction: column;
            height: 480px; /* â˜… é«˜ã•ã‚’å°‘ã—æŠ‘ãˆã‚‹ */
        }
        
        .window-title-bar {
            background: var(--color-text-main); color: #fff; padding: 10px 15px;
            font-weight: 700; font-size: 0.95rem;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; /* ã‚¿ã‚¤ãƒˆãƒ«ãƒãƒ¼ãŒç¸®ã¾ãªã„ã‚ˆã†ã« */
        }
        .window-status { font-size: 0.8rem; background: #555; padding: 2px 8px; border-radius: 4px; }

        /* Terminal */
        .terminal-content {
            background-color: #1a1a1a; color: #f0f0f0;
            padding: 15px; font-family: var(--font-mono); font-size: 1.05rem;
            flex-grow: 1; overflow-y: auto;
        }
        .prompt { color: #4caf50; margin-right: 8px; font-weight: bold; }
        .input-line { display: flex; margin-top: 5px; }
        #terminal-input {
            flex-grow: 1; background: transparent; border: none; color: #fff;
            font-family: inherit; font-size: inherit; outline: none;
        }

        /* Browser */
        .browser-toolbar {
            background: #f3f4f6; border-bottom: 1px solid #d1d5db; padding: 10px;
            display: flex; gap: 10px; align-items: center;
            flex-shrink: 0;
        }
        .url-bar {
            flex-grow: 1; background: #fff; border: 1px solid #9ca3af; padding: 8px 12px;
            border-radius: 4px; font-family: sans-serif; color: var(--color-text-main);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .browser-content {
            flex-grow: 1; padding: 30px; text-align: center; position: relative;
            overflow-y: auto;
        }
        .fake-logo { font-size: 2rem; font-weight: 900; color: var(--color-text-main); margin-bottom: 20px; }
        .search-form { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .search-input {
            padding: 10px; width: 70%; min-width: 200px;
            border: 2px solid var(--color-text-sub); border-radius: 4px; font-size: 1rem;
        }
        .search-btn {
            padding: 10px 20px; background: var(--color-text-main); color: #fff; border: none;
            border-radius: 4px; font-weight: bold; cursor: pointer;
        }

        /* ã‚¢ãƒ©ãƒ¼ãƒˆ */
        .alert-modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center;
            z-index: 50;
        }
        .alert-box {
            background: #fff; border: 3px solid var(--color-accent);
            padding: 30px; width: 80%; max-width: 300px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); border-radius: 8px;
        }
        .alert-title {
            color: var(--color-accent); font-size: 1.4rem; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: bold;
        }
        .alert-btn {
            margin-top: 20px; padding: 10px 25px; background: var(--color-accent); color: #fff;
            border: none; font-weight: bold; font-size: 1rem; cursor: pointer; border-radius: 4px;
        }

        /* --- ã‚³ãƒ¼ãƒ‰è§£æ --- */
        .code-viewer {
            display: none; background: #2d2d2d; color: #f8f8f2;
        }
        .code-viewer.visible { display: block; }
        
        .code-columns { display: flex; border-top: 1px solid #555; }
        .code-col { flex: 1; padding: 15px; border-right: 1px solid #555; overflow: hidden; }
        .code-col:last-child { border-right: none; }
        
        .col-label {
            display: inline-block; padding: 4px 8px; border-radius: 4px;
            font-size: 0.85rem; font-weight: 700; margin-bottom: 10px;
        }
        .label-bad { background: var(--color-accent); color: #fff; }
        .label-good { background: var(--color-success); color: #fff; }
        
        pre { margin: 0; overflow-x: auto; font-family: var(--font-mono); line-height: 1.5; white-space: pre-wrap; word-break: break-all; }

        /* --- ã‚¯ã‚¤ã‚º (å…¨å¹…è¡¨ç¤º) --- */
        .quiz-container-full {
            margin-top: 0;
        }
        .quiz-title {
            font-size: 1.2rem; margin-bottom: 20px; font-weight: 700;
        }
        
        .quiz-options {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
        }
        @media (max-width: 600px) { .quiz-options { grid-template-columns: 1fr; } }

        .quiz-choice {
            background: #fff; border: 2px solid var(--color-border); padding: 20px;
            border-radius: 8px; cursor: pointer; text-align: left; font-weight: 500;
            transition: all 0.2s; display: flex; align-items: center; gap: 15px;
            font-size: 1rem;
        }
        .quiz-choice:hover { border-color: var(--color-primary); background: #f0f9ff; }
        .quiz-choice:focus { border-color: var(--color-primary); box-shadow: var(--focus-ring); }
        
        .choice-marker {
            width: 30px; height: 30px; border: 2px solid #9ca3af; border-radius: 50%;
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #6b7280; background: #fff;
        }

        .quiz-explanation {
            margin-top: 25px; padding: 20px; background-color: #e8f5e9;
            border: 1px solid #c8e6c9; border-radius: 8px; display: none;
        }
        .explanation-title { color: var(--color-success); font-weight: 700; margin-bottom: 10px; font-size: 1.1rem; }
        .retry-btn {
            margin-top: 15px; padding: 8px 16px; background: #fff; border: 1px solid var(--color-border);
            border-radius: 4px; cursor: pointer; font-weight: 500;
        }

        /* --- ãƒ•ãƒƒã‚¿ãƒ¼ --- */
        footer {
            text-align: center; padding: 40px 20px;
            background: var(--color-surface); border-top: 1px solid var(--color-border);
            margin-top: 60px; color: var(--color-text-sub);
        }
        
        /* æ¬¡ã¸é€²ã‚€ãƒœã‚¿ãƒ³ (ä¸‹éƒ¨) */
        .bottom-nav {
            text-align: right; margin-top: 30px;
        }
        .bottom-next-btn {
            display: inline-flex; align-items: center; gap: 10px;
            background: var(--color-primary); color: #fff;
            padding: 14px 35px; border-radius: 50px; text-decoration: none;
            font-weight: 700; font-size: 1.1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15); transition: 0.2s;
        }
        .bottom-next-btn:hover { background: var(--color-primary-dark); transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.15); }

    </style>
</head>
<body>
    
    <!-- ãƒ‡ãƒ¼ã‚¿å—ã‘æ¸¡ã— (éè¡¨ç¤º) -->
    <script id="data-video-id" type="application/json">{{ video_id | tojson | safe }}</script>
    <script id="data-target" type="application/json">{{ target_keyword | tojson | safe }}</script>
    <script id="data-success" type="application/json">{{ success_message | tojson | safe }}</script>
    <script id="data-exp-type" type="application/json">{{ experience_type | tojson | safe }}</script>
    <script id="data-puzzle" type="application/json">{{ puzzle_data | tojson | safe }}</script>
    <script id="data-quiz" type="application/json">{{ quiz_data | tojson | safe }}</script>
    <script id="data-vuln-id" type="application/json">{{ vuln_id | tojson | safe }}</script>

    <header class="ud-header">
        <div class="site-logo">
            <a href="/top">
                <span class="material-icons-round icon" aria-hidden="true">security</span>
                <span>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å­¦ç¿’ãƒãƒ¼ã‚¿ãƒ«</span>
            </a>
        </div>
        <div class="user-menu">
            <a href="/login" id="auth-button" class="header-btn">
                <span class="material-icons-round" aria-hidden="true">login</span>
                <span>ãƒ­ã‚°ã‚¤ãƒ³</span>
            </a>
        </div>
    </header>

    <div class="main-wrapper">
        
        <nav class="breadcrumb-nav" aria-label="ãƒ‘ãƒ³ããšãƒªã‚¹ãƒˆ">
            <a href="/top" class="nav-link">
                <span class="material-icons-round icon" aria-hidden="true">arrow_back</span>
                <span>å­¦ç¿’ä¸€è¦§ã«æˆ»ã‚‹</span>
            </a>
            
            <a href="#" id="next-lesson-top" class="nav-link next-link" style="display:none;">
                <span>æ¬¡ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸</span>
                <span class="material-icons-round icon" aria-hidden="true">arrow_forward</span>
            </a>
        </nav>

        <div class="content-grid">
            
            <!-- å·¦ã‚«ãƒ©ãƒ : å­¦ç¿’è³‡æ–™ -->
            <div class="left-col">
                <section class="ud-card" aria-labelledby="lesson-heading">
                    <div class="card-header">
                        <span class="material-icons-round" aria-hidden="true">play_circle_filled</span>
                        <span id="lesson-heading">å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</span>
                    </div>
                    <div class="card-body">
                        
                        <div class="video-container">
                            <iframe id="video-player" src="" frameborder="0" allowfullscreen title="è§£èª¬å‹•ç”»"></iframe>
                        </div>

                        <div class="lesson-header">
                            <h1 class="lesson-title">{{ content_title }}</h1>
                            
                            <!-- UDã‚¹ã‚¤ãƒƒãƒ -->
                            <label class="ud-checkbox">
                                <input type="checkbox" id="progress-check">
                                <span class="ud-checkbox-label" id="progress-label">å­¦ç¿’ã‚’å®Œäº†ã«ã™ã‚‹</span>
                            </label>
                        </div>

                        <p class="lesson-description">{{ content_desc }}</p>

                        <hr style="border:0; border-top:1px solid #eee; margin: 30px 0;">

                        <!-- ãƒ‘ã‚ºãƒ« -->
                        <div class="puzzle-area">
                            <div class="puzzle-header">
                                <h3 style="margin:0; font-size:1.1rem; color:var(--color-primary-dark); display:flex; align-items:center; gap:5px;">
                                    <span class="material-icons-round" aria-hidden="true">extension</span>
                                    æ”»æ’ƒã‚³ãƒ¼ãƒ‰ä½œæˆãƒ‘ã‚ºãƒ«
                                </h3>
                                <div class="puzzle-actions">
                                    <button onclick="resetInput()">ãƒªã‚»ãƒƒãƒˆ</button>
                                    <button onclick="toggleAnswer()">æ­£è§£ã‚’è¦‹ã‚‹</button>
                                </div>
                            </div>
                            <p style="font-size:0.9rem; margin-bottom:15px; color:var(--color-text-sub);">
                                ä»¥ä¸‹ã®ãƒ‘ãƒ¼ãƒ„ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€æ”»æ’ƒã‚³ãƒãƒ³ãƒ‰ã‚’çµ„ã¿ç«‹ã¦ã¦ãã ã•ã„ã€‚
                            </p>
                            
                            <div class="word-bank" id="word-bank" role="list" aria-label="ãƒ‘ã‚ºãƒ«ã®ãƒ”ãƒ¼ã‚¹"></div>
                            
                            <div id="answer-area" class="answer-feedback" role="alert">
                                <strong>ğŸ’¡ æ­£è§£ã®ã‚³ãƒãƒ³ãƒ‰:</strong> <span id="answer-code" style="font-family:monospace; margin-left:10px;"></span>
                            </div>
                        </div>

                    </div>
                </section>
            </div>

            <!-- å³ã‚«ãƒ©ãƒ : æ¼”ç¿’ç’°å¢ƒ -->
            <div class="right-col">
                
                <!-- TERMINAL -->
                <div id="window-terminal" class="window-frame" style="display:none;">
                    <div class="window-title-bar">
                        <span>ã‚¿ãƒ¼ãƒŸãƒŠãƒ« (ã‚µãƒ¼ãƒãƒ¼æ“ä½œ)</span>
                        <span class="window-status">æ¥ç¶šä¸­</span>
                    </div>
                    <div class="terminal-content" id="terminal-body" role="log" aria-live="polite">
                        <div>> ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ã«æ¥ç¶šã—ã¾ã—ãŸã€‚</div>
                        <div style="color:#aaa; margin-bottom:15px;">ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦Enterã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
                        <div id="output-history"></div>
                        <div class="input-line">
                            <span class="prompt">admin@server:~$</span>
                            <input type="text" id="terminal-input" autocomplete="off" aria-label="ã‚³ãƒãƒ³ãƒ‰å…¥åŠ›">
                        </div>
                    </div>
                </div>

                <!-- BROWSER -->
                <div id="window-browser" class="window-frame" style="display:none; border-color:#ccc;">
                    <div class="window-title-bar" style="background:#e0e0e0; color:#333;">
                        <span>Webãƒ–ãƒ©ã‚¦ã‚¶</span>
                        <span class="window-status" style="background:#ccc;">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
                    </div>
                    <div class="browser-toolbar">
                        <span class="material-icons-round" style="color:#777;">arrow_back</span>
                        <span class="material-icons-round" style="color:#777;">arrow_forward</span>
                        <div class="url-bar">http://vulnerable-site.com/search</div>
                    </div>
                    <div class="browser-content">
                        <div class="fake-logo">Search <span style="color:var(--color-primary)">Me</span></div>
                        <div class="search-form">
                            <input type="text" id="browser-input" class="search-input" placeholder="æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" autocomplete="off" aria-label="æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰">
                            <button class="search-btn" onclick="checkInput()">æ¤œç´¢</button>
                        </div>
                        
                        <!-- Alert Modal -->
                        <div id="fake-alert-overlay" class="alert-modal-overlay">
                            <div class="alert-box" role="alertdialog" aria-modal="true" aria-labelledby="alert-title" aria-describedby="alert-msg">
                                <div id="alert-title" class="alert-title">
                                    <span class="material-icons-round" aria-hidden="true">warning</span>
                                    è­¦å‘Š
                                </div>
                                <p id="alert-msg" style="font-size:1.1rem; font-weight:bold;">XSSè„†å¼±æ€§ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ</p>
                                <button class="alert-btn" onclick="closeAlert()">é–‰ã˜ã‚‹</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Code Analysis (Toggle) -->
                <div class="ud-card" style="margin-top:20px; border-color:var(--color-primary);">
                    <div class="card-header" style="background:var(--color-primary); color:#fff;">
                        <span class="material-icons-round" aria-hidden="true">code</span>
                        ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰è§£èª¬
                    </div>
                    <div id="secret-code-section" class="code-viewer">
                        <div class="code-columns">
                            <div class="code-col">
                                <span class="col-label label-bad">Ã— è„†å¼±ãªã‚³ãƒ¼ãƒ‰</span>
                                <pre>{{ vulnerable_code }}</pre>
                            </div>
                            <div class="code-col">
                                <span class="col-label label-good">â—‹ å¯¾ç­–æ¸ˆã¿ã‚³ãƒ¼ãƒ‰</span>
                                <pre>{{ fixed_code }}</pre>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ã‚¯ã‚¤ã‚º (å…¨å¹…) -->
        <section class="ud-card" aria-labelledby="quiz-heading">
            <div class="card-header">
                <span class="material-icons-round" aria-hidden="true">quiz</span>
                <span id="quiz-heading">ç†è§£åº¦ãƒã‚§ãƒƒã‚¯</span>
            </div>
            <div class="card-body quiz-container-full" id="quiz-container">
                <p style="text-align:center; color:#777;">ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
            </div>
        </section>

        <div class="bottom-nav">
            <a href="#" id="next-lesson-bottom" class="bottom-next-btn" style="display:none;">
                æ¬¡ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸é€²ã‚€
                <span class="material-icons-round" aria-hidden="true">arrow_forward</span>
            </a>
        </div>

    </div>

    <footer>
        <p>&copy; 2025 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å­¦ç¿’ãƒãƒ¼ã‚¿ãƒ« | ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã«é…æ…®ã—ãŸãƒ‡ã‚¶ã‚¤ãƒ³</p>
    </footer>

    <script>
        // --- å…±é€šå‡¦ç†: JSONãƒ‡ãƒ¼ã‚¿å–å¾— ---
        function getJsonFromTag(id) {
            const el = document.getElementById(id);
            if (!el) return null;
            try {
                const text = el.textContent.trim();
                if (!text || text === 'null' || text === 'None') return null;
                let parsed = JSON.parse(text);
                if (typeof parsed === 'string') {
                    if (parsed.startsWith('[') || parsed.startsWith('{')) { try { return JSON.parse(parsed); } catch(e) { return parsed; } }
                }
                return parsed;
            } catch (e) { console.error(`JSON Parse Error (${id}):`, e); return null; }
        }

        const contentData = {
            videoId:       getJsonFromTag('data-video-id') || "",
            targetCommand: getJsonFromTag('data-target') || "",
            successMessage: getJsonFromTag('data-success') || "æˆåŠŸã—ã¾ã—ãŸï¼",
            experienceType: getJsonFromTag('data-exp-type') || "TERMINAL",
            puzzleData:    getJsonFromTag('data-puzzle') || [],
            quizData:      getJsonFromTag('data-quiz') 
        };

        // --- åˆæœŸåŒ–å‡¦ç† ---
        function getYoutubeId(url) {
            if (!url) return "";
            const match = url.match(/[\?\&]v=([^&]+)/) || url.match(/\/embed\/([^?]+)/) || url.match(/^[\w-]{11}$/);
            return (match && match.length > 0) ? (match[1] || match[0]) : url;
        }

        if (contentData.videoId) {
            document.getElementById('video-player').src = `https://www.youtube.com/embed/${getYoutubeId(contentData.videoId)}`;
        }
        document.getElementById('answer-code').textContent = contentData.targetCommand;

        // ãƒ‘ã‚ºãƒ«ç”Ÿæˆ
        const wordBank = document.getElementById('word-bank');
        if (contentData.puzzleData && Array.isArray(contentData.puzzleData)) {
            const shuffled = [...contentData.puzzleData].sort(() => Math.random() - 0.5);
            shuffled.forEach(part => {
                const chip = document.createElement('button'); // buttonã‚¿ã‚°ã§ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š
                chip.className = 'word-chip';
                chip.textContent = part.text;
                chip.onclick = () => addInput(part.text);
                wordBank.appendChild(chip);
            });
        } else { wordBank.innerHTML = '<span>ãƒ‘ã‚ºãƒ«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</span>'; }

        // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
        if (contentData.experienceType === 'BROWSER') {
            document.getElementById('window-browser').style.display = 'flex';
        } else {
            document.getElementById('window-terminal').style.display = 'flex';
        }

        // ã‚¯ã‚¤ã‚ºç”Ÿæˆ
        if (contentData.quizData) {
            const q = contentData.quizData;
            const container = document.getElementById('quiz-container');
            container.innerHTML = `
                <h3 class="quiz-title">å•é¡Œ: ${q.question}</h3>
                <div id="quiz-options-box" class="quiz-options"></div>
                <div id="quiz-explanation" class="quiz-explanation">
                    <h4 class="explanation-title">è§£èª¬</h4>
                    <p><strong>æ­£è§£: ${q.answer}</strong></p>
                    <p>${q.explanation}</p>
                    <button class="retry-btn" onclick="resetQuiz()">ã‚‚ã†ä¸€åº¦è§£ã</button>
                </div>
            `;
            
            const optionsBox = document.getElementById('quiz-options-box');
            q.options.forEach(opt => {
                if(opt.text) { 
                    const btn = document.createElement('button'); // buttonã‚¿ã‚°
                    btn.className = 'quiz-choice';
                    btn.innerHTML = `<span class="choice-marker">${opt.label}</span> <span>${opt.text}</span>`;
                    btn.onclick = function() { checkQuiz(this, opt.label === q.answer); };
                    optionsBox.appendChild(btn);
                }
            });
        }

        // --- å…¥åŠ›ãƒ­ã‚¸ãƒƒã‚¯ ---
        function addInput(text) {
            const inputId = contentData.experienceType === 'BROWSER' ? 'browser-input' : 'terminal-input';
            const input = document.getElementById(inputId);
            let val = input.value;
            if (val.length > 0 && !val.endsWith(' ')) val += ' ';
            input.value = val + text;
            input.focus();
        }
        function resetInput() {
            const inputId = contentData.experienceType === 'BROWSER' ? 'browser-input' : 'terminal-input';
            document.getElementById(inputId).value = '';
            document.getElementById(inputId).focus();
        }
        function toggleAnswer() {
            const area = document.getElementById('answer-area');
            area.style.display = (area.style.display === 'block') ? 'none' : 'block';
        }

        const outputHistory = document.getElementById('output-history');
        const codeSection = document.getElementById('secret-code-section');

        function checkInput() {
            const isBrowser = (contentData.experienceType === 'BROWSER');
            const inputId = isBrowser ? 'browser-input' : 'terminal-input';
            const input = document.getElementById(inputId);
            const val = input.value.trim();
            if (!val) return;

            const normalize = s => s.replace(/\s+/g, '').replace(/'/g, '"');
            const target = contentData.targetCommand || "IMPOSSIBLE";
            const normalizedTarget = normalize(target);
            const isCorrect = normalize(val).includes(normalizedTarget);

            if (isBrowser) {
                if (isCorrect) {
                    document.getElementById('fake-alert-overlay').style.display = 'flex';
                    document.getElementById('alert-msg').textContent = contentData.successMessage;
                    revealCodeSection();
                } else { alert("ä½•ã‚‚èµ·ãã¾ã›ã‚“ã§ã—ãŸã€‚"); }
            } else {
                addLog(`admin@server:~$ ${val}`, '#fff');
                setTimeout(() => {
                    if (isCorrect) {
                        addLog(`>> æˆåŠŸ: ${contentData.successMessage}`, "#0f0");
                        revealCodeSection();
                    } else { addLog(">> ã‚¨ãƒ©ãƒ¼: ã‚³ãƒãƒ³ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚", "#f55"); }
                    // terminalBody.scrollTop = terminalBody.scrollHeight;
                }, 200);
                input.value = '';
            }
        }

        ['terminal-input', 'browser-input'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('keydown', e => { if(e.key === 'Enter') checkInput(); });
        });

        function addLog(text, color) {
            const div = document.createElement('div');
            div.textContent = text;
            div.style.color = color;
            div.style.marginBottom = "5px";
            document.getElementById('output-history').appendChild(div);
        }
        function closeAlert() { document.getElementById('fake-alert-overlay').style.display = 'none'; }
        
        function revealCodeSection() {
            if (codeSection) {
                codeSection.classList.add('visible');
                codeSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function checkQuiz(button, isCorrect) {
            const parent = button.parentElement;
            if (parent.classList.contains('answered')) return;
            parent.classList.add('answered');
            
            if (isCorrect) {
                button.style.backgroundColor = "#e8f5e9";
                button.style.borderColor = "var(--color-success)";
                button.innerHTML += ' <strong class="status-text" style="color:var(--color-success); margin-left:auto;">â— æ­£è§£</strong>';
            } else {
                button.style.backgroundColor = "#ffebee";
                button.style.borderColor = "var(--color-accent)";
                button.innerHTML += ' <strong class="status-text" style="color:var(--color-accent); margin-left:auto;">Ã— ä¸æ­£è§£</strong>';
                
                // æ­£è§£ã‚’è¡¨ç¤º
                const btns = parent.children;
                for(let btn of btns) {
                    if(btn.innerText.includes(contentData.quizData.answer)) {
                        btn.style.borderColor = "var(--color-success)";
                        btn.style.backgroundColor = "#e8f5e9";
                    }
                }
            }
            document.getElementById('quiz-explanation').style.display = 'block';
        }

        function resetQuiz() {
            const optionsBox = document.getElementById('quiz-options-box');
            optionsBox.classList.remove('answered');
            document.getElementById('quiz-explanation').style.display = 'none';
            // é¸æŠè‚¢ã®å†æç”»ãŒå¿…è¦ã ãŒã€ç°¡æ˜“çš„ã«ãƒªãƒ­ãƒ¼ãƒ‰ã‚’ä¿ƒã™ã‹ã€HTMLã‚’å†ç”Ÿæˆã™ã‚‹
            // ã“ã“ã§ã¯ç°¡æ˜“çš„ã«è‰²ã‚’æˆ»ã™å‡¦ç†ã®ã¿
            const btns = optionsBox.children;
            for (let btn of btns) {
                btn.style.backgroundColor = "#fff";
                btn.style.borderColor = "#ccc";
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤ (ç°¡æ˜“å®Ÿè£…)
                const statusSpan = btn.querySelector('.status-text');
                if(statusSpan) statusSpan.remove();
            }
            // å®Œå…¨ãƒªã‚»ãƒƒãƒˆã®ãŸã‚ãƒªãƒ­ãƒ¼ãƒ‰æ¨å¥¨ã ãŒã€ç°¡æ˜“ãƒªã‚»ãƒƒãƒˆ
        }

        // --- èªè¨¼ãƒ»é€²æ—ç®¡ç† ---
        document.addEventListener('DOMContentLoaded', function () {
            const authButton = document.getElementById('auth-button');
            const token = localStorage.getItem('jwt_token'); 
            
            if (token) { 
                authButton.innerHTML = '<span class="material-icons-round icon" aria-hidden="true">account_circle</span> <span>ãƒã‚¤ãƒšãƒ¼ã‚¸</span>';
                authButton.href = '/mypage'; 
            } else { 
                authButton.innerHTML = '<span class="material-icons-round icon" aria-hidden="true">login</span> <span>ãƒ­ã‚°ã‚¤ãƒ³</span>';
                authButton.href = '/login'; 
            }

            const progressCheck = document.getElementById('progress-check');
            const progressLabel = document.getElementById('progress-label');
            let currentVulnId = getJsonFromTag('data-vuln-id');
            
            if (!currentVulnId) {
                const matches = window.location.pathname.match(/\/(\d+)$/);
                if (matches) currentVulnId = parseInt(matches[1]);
            }

            // æ¬¡ã¸ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
            if (currentVulnId) {
                fetch('/api/vulnerabilities').then(res => res.json()).then(data => {
                    if (data.success && data.data.length > 0) {
                        const allIds = data.data.map(v => v.vuln_id).sort((a,b)=>a-b);
                        const currentIndex = allIds.indexOf(currentVulnId);
                        if (currentIndex !== -1) {
                            let nextIndex = currentIndex + 1;
                            if (nextIndex >= allIds.length) nextIndex = 0;
                            const nextId = allIds[nextIndex];
                            
                            const topBtn = document.getElementById('next-lesson-top');
                            const bottomBtn = document.getElementById('next-lesson-bottom');
                            
                            if (topBtn) { topBtn.href = `/lesson/${nextId}`; topBtn.style.display = 'inline-flex'; }
                            if (bottomBtn) { bottomBtn.href = `/lesson/${nextId}`; bottomBtn.style.display = 'inline-flex'; }
                        }
                    }
                });
            }

            if (token && currentVulnId) {
                fetch('/api/progress/all', { headers: { 'Authorization': `Bearer ${token}` } })
                .then(res => res.json()).then(data => {
                    if (data.success) {
                        const item = data.data.find(d => d.vuln_id === currentVulnId);
                        if (item && item.status === 'COMPLETED') {
                            progressCheck.checked = true;
                            progressLabel.textContent = "å­¦ç¿’æ¸ˆã¿ï¼ˆå®Œäº†ï¼‰";
                            progressLabel.style.color = "var(--color-success)";
                        }
                    }
                });

                progressCheck.addEventListener('change', function() {
                    const isCompleted = this.checked;
                    progressLabel.textContent = isCompleted ? "å­¦ç¿’æ¸ˆã¿ï¼ˆå®Œäº†ï¼‰" : "å­¦ç¿’ã‚’å®Œäº†ã«ã™ã‚‹";
                    progressLabel.style.color = isCompleted ? "var(--color-success)" : "var(--color-text-sub)";
                    
                    fetch('/api/progress/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ vuln_id: currentVulnId, completed: isCompleted })
                    }).then(res => res.json()).then(res => {
                        if(!res.success) {
                            alert('é€²æ—ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                            this.checked = !isCompleted;
                        }
                    });
                });
            } else if (progressCheck) {
                progressCheck.disabled = true;
                progressLabel.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™";
            }
        });
    </script>
</body>
</html>